<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STATE GATES | Medicine 3.0 Dashboard</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background-color: #0f172a; color: #f8fafc; padding: 20px; }
        .container { max-width: 600px; margin: auto; border: 1px solid #334155; padding: 20px; background: #1e293b; border-radius: 8px; }
        h1 { color: #38bdf8; border-bottom: 2px solid #38bdf8; text-align: center; }
        .token-card { background: #334155; padding: 15px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .red { border-left: 5px solid #dc2626; }
        .blue { border-left: 5px solid #2563eb; }
        .gold { border-left: 5px solid #ca8a04; }
        .history { font-size: 0.8rem; color: #94a3b8; margin-top: 20px; max-height: 200px; overflow-y: auto; }
        button { width: 100%; padding: 10px; background: #38bdf8; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>STATE GATES: BIO-LOG</h1>
    <div id="status-update" style="text-align: center; padding: 10px; font-weight: bold; color: #fbbf24;"></div>
    
    <div id="dashboard">
        </div>

    <div class="history">
        <h3>LATEST CLINICAL EVENTS:</h3>
        <ul id="log-list"></ul>
    </div>
    
    <button onclick="localStorage.clear(); location.reload();">EMERGENCY SYSTEM RESET</button>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const cardID = urlParams.get('card');
    
    // The Master Library matching your CSV
    const cardLibrary = {
        "b_r1": { name: "Toe Yoga", cat: "Body", color: "red" },
        "b_b1": { name: "Zone 2 Walk", cat: "Body", color: "blue" },
        "b_b2": { name: "Farmer's Carry", cat: "Body", color: "blue" },
        "b_g1": { name: "Heathrow Sprint", cat: "Body", color: "gold" },
        "s_r1": { name: "Thermal Switch", cat: "Sleep", color: "red" },
        "s_b1": { name: "Wake Anchor", cat: "Sleep", color: "blue" },
        "s_b2": { name: "3-Hr Buffer", cat: "Sleep", color: "blue" },
        "s_g1": { name: "Digital Sunset", cat: "Sleep", color: "gold" },
        "n_r1": { name: "Fiber Buffer", cat: "Nutrition", color: "red" },
        "n_b1": { name: "Protein Pulse", cat: "Nutrition", color: "blue" },
        "n_b2": { name: "1g/lb Target", cat: "Nutrition", color: "blue" },
        "n_g1": { name: "SAD Escape", cat: "Nutrition", color: "gold" },
        "e_r1": { name: "4-7-8 Reset", cat: "Emotional", color: "red" },
        "e_b1": { name: "Patient Reframe", cat: "Emotional", color: "blue" },
        "e_b2": { name: "Eulogy Virtue", cat: "Emotional", color: "blue" },
        "e_g1": { name: "Vulnerability", cat: "Emotional", color: "gold" }
    };

    // Logic: If a card was scanned
    if (cardID && cardLibrary[cardID]) {
        const item = cardLibrary[cardID];
        
        // Update Token Count
        let counts = JSON.parse(localStorage.getItem('gate_tokens') || "{}");
        counts[cardID] = (counts[cardID] || 0) + 1;
        localStorage.setItem('gate_tokens', JSON.stringify(counts));
        
        // Log History
        let logs = JSON.parse(localStorage.getItem('longevity_logs') || "[]");
        logs.unshift({ task: item.name, time: new Date().toLocaleTimeString() });
        localStorage.setItem('longevity_logs', JSON.stringify(logs.slice(0, 10)));
        
        document.getElementById('status-update').innerText = `SUCCESS: ${item.name.toUpperCase()} BANKED`;
        
        // Clean URL after 3 seconds
        setTimeout(() => { window.history.replaceState({}, document.title, window.location.pathname); }, 3000);
    }

    // Render Dashboard
    function render() {
        const counts = JSON.parse(localStorage.getItem('gate_tokens') || "{}");
        const logs = JSON.parse(localStorage.getItem('longevity_logs') || "[]");
        const dash = document.getElementById('dashboard');
        dash.innerHTML = "";

        Object.keys(cardLibrary).forEach(id => {
            if (counts[id]) {
                const item = cardLibrary[id];
                dash.innerHTML += `
                    <div class="token-card ${item.color}">
                        <span>${item.name} (${item.cat})</span>
                        <span style="font-size: 1.5rem; font-weight: bold;">${counts[id]}</span>
                    </div>
                `;
            }
        });

        document.getElementById('log-list').innerHTML = logs.map(l => `<li>[${l.time}] ${l.task}</li>`).join('');
    }

    render();
</script>
</body>
</html>
